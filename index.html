<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í­ê·„ ì„œë²„ ê²€ìƒ‰ê¸°</title>
  <meta name="theme-color" content="#111827" />
  <style>
    :root{ --bg:#0b1220; --panel:#111827; --muted:#6b7280; --txt:#e5e7eb; --brand:#60a5fa; --accent:#34d399; --danger:#f87171; --ring:0 0 0 3px rgba(96,165,250,.35); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--txt)}
    .wrap{max-width:1200px; margin:0 auto; padding:16px}

    header{position:sticky; top:0; z-index:60; backdrop-filter:saturate(1.2) blur(8px); background:linear-gradient(to bottom, rgba(11,18,32,.9), rgba(11,18,32,.4)); border-bottom:1px solid rgba(255,255,255,.06)}
    .h-inner{max-width:1200px; margin:0 auto; padding:12px 16px; display:grid; grid-template-columns:1fr auto; gap:12px; align-items:center}
    .title{display:flex; align-items:center; gap:10px; font-weight:700}
    .title small{font-size:12px; color:var(--muted)}
    .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}

    .btn{appearance:none; border:1px solid rgba(255,255,255,.08); background:var(--panel); color:var(--txt); padding:8px 12px; border-radius:10px; cursor:pointer; display:inline-flex; gap:8px; align-items:center}
    .btn:hover{border-color:rgba(255,255,255,.16)}
    .btn:focus{outline:none; box-shadow:var(--ring)}
    .btn[aria-pressed="true"], .btn.active{border-color:var(--brand); box-shadow:0 0 0 1px rgba(96,165,250,.35) inset}
    .btn.ghost{background:transparent}

    .chipbar{display:flex; gap:6px; flex-wrap:wrap}
    .chip{border:1px solid rgba(255,255,255,.08); padding:6px 10px; border-radius:999px; background:#0e1628; color:#cbd5e1; cursor:pointer}
    .chip[aria-pressed="true"]{border-color:var(--accent); color:#10b981; background:rgba(16,185,129,.08)}

    .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .input{height:36px; padding:0 12px; border:1px solid rgba(255,255,255,.08); background:#0e1628; color:var(--txt); border-radius:10px}
    .input:focus{outline:none; box-shadow:var(--ring)}

    .panel{background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:12px}
    .row{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .muted{color:var(--muted)}
    .tag{display:inline-flex; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.1); font-size:12px; color:#9ca3af}

    .hidden{display:none !important}

    /* ë ˆì´ì•„ì›ƒ: ë©”ì¸ + ìš°ì¸¡ ë©”ëª¨ ê³ ì • */
    .layout{display:grid; grid-template-columns: 1fr 320px; gap:16px}
    main{display:grid; gap:14px}
    aside.memo{position:sticky; top:84px; height: calc(100vh - 100px); display:flex; flex-direction:column}
    .memo-head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px}
    .memo-box{flex:1; resize:none; width:100%; border-radius:12px; padding:12px; background:#0e1628; border:1px solid rgba(255,255,255,.08); color:var(--txt)}
    .memo-box:focus{outline:none; box-shadow:var(--ring)}
    .memo-foot{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:8px; font-size:12px; color:#9ca3af}

    /* ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ */
    .list{display:grid; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); gap:12px}
    .card{background:#0e1628; border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:10px; cursor:default}
    .card.clickable{cursor:pointer}
    .card h3{margin:0; font-size:16px}

    /* ë¹ˆ ìƒíƒœ */
    .empty{padding:28px; text-align:center; color:#9ca3af}
    .empty b{color:#e5e7eb}

    /* í…Œì´ë¸” (ì»¬ë ‰ì…˜ë¶) */
    .tbl{width:100%; border-collapse:separate; border-spacing:0 8px}
    .tbl th, .tbl td{ padding:10px 12px; text-align:left }
    .tbl thead th{ font-size:12px; color:#9ca3af }
    .tbl tbody tr{ background:#0e1628; border:1px solid rgba(255,255,255,.06) }
    .tbl tbody tr td:first-child{ border-radius:10px 0 0 10px }
    .tbl tbody tr td:last-child{ border-radius:0 10px 10px 0 }

    /* ì§„í–‰ë°” */
    .prog{height:10px; background:#0e1628; border:1px solid rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
    .prog > span{display:block; height:100%; background:linear-gradient(90deg, var(--accent), var(--brand))}

    /* ëª¨ë°”ì¼: ë©”ëª¨ ì ‘ê¸°/í¼ì¹˜ê¸° */
    #btnMemo{display:none}
    @media (max-width: 960px){
      .layout{grid-template-columns:1fr}
      aside.memo{position:fixed; right:12px; bottom:12px; top:auto; width: min(540px, calc(100vw - 24px)); height: 50vh; z-index:80; display:none}
      aside.memo.open{display:flex}
      #btnMemo{display:inline-flex}
    }

    /* ëª¨ë‹¬ */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:90}
    .modal.open{display:flex}
    .backdrop{position:absolute; inset:0; background:rgba(0,0,0,.5)}
    .dialog{position:relative; width:min(480px,90vw); background:var(--panel); border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:16px; box-shadow:0 15px 50px rgba(0,0,0,.45)}
    .dialog h3{margin:0 0 8px 0}
    .dialog .row{gap:12px}
    .dialog .input{width:100%}
  </style>
</head>
<body>
  <header>
    <div class="h-inner" role="group" aria-label="ìƒë‹¨ ë„êµ¬ë§‰ëŒ€">
      <div class="title" aria-live="polite">
        <span>ğŸ§ í­ê·„ ì„œë²„ ê²€ìƒ‰ê¸°</span>
        <small id="subtitle">ê²€ìƒ‰</small>
      </div>
      <div class="controls">
        <!-- ë¬´ì—­ì„¬ ë²„íŠ¼ì€ 'ê²€ìƒ‰' í™”ë©´ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë˜ ëª¨ë“œë§Œ ì „í™˜ -->
        <button id="btnTrade" class="btn" aria-pressed="false" title="ë¬´ì—­ì„¬ ëª¨ë“œ í† ê¸€(T)">ğŸï¸ ë¬´ì—­ì„¬</button>
        <button id="btnCollection" class="btn" aria-pressed="false" title="ì»¬ë ‰ì…˜ë¶ ì—´ê¸°(C)">ğŸ“š ì»¬ë ‰ì…˜ë¶</button>
        <button id="btnFavoritesOnly" class="btn ghost" aria-pressed="false" title="ì¦ê²¨ì°¾ê¸°ë§Œ ë³´ê¸°(F)">â­ ì¦ê²¨ì°¾ê¸°ë§Œ</button>
        <input id="q" class="input" type="search" placeholder="ê²€ìƒ‰ (/)" aria-label="ê²€ìƒ‰">
        <button id="btnMemo" class="btn ghost" title="ë©”ëª¨ ì—´ê¸°/ë‹«ê¸°(M)">ğŸ“ ë©”ëª¨</button>
      </div>
    </div>
  </header>

  <div class="wrap layout">
    <!-- ì¢Œì¸¡: ì½˜í…ì¸  (ê²€ìƒ‰/ì»¬ë ‰ì…˜) -->
    <div>
      <!-- ê²€ìƒ‰/ë¬´ì—­ì„¬ í†µí•© í™”ë©´ -->
      <main id="view-search" aria-label="ê²€ìƒ‰ í™”ë©´">
        <section class="panel toolbar" aria-label="í•„í„°">
          <div class="chipbar" id="catChips" role="group" aria-label="ì¹´í…Œê³ ë¦¬"></div>
          <select id="tier" class="input" title="ì°¨ìˆ˜">
            <option value="">ì „ì²´ ì°¨ìˆ˜</option>
            <option>1ì°¨</option>
            <option>2ì°¨</option>
            <option>3ì°¨</option>
            <option>4ì°¨</option>
            <option>5ì°¨</option>
            <option>6ì°¨</option>
          </select>
        </section>

        <section class="panel" aria-label="ê²°ê³¼ ëª©ë¡">
          <div id="list" class="list" aria-live="polite"></div>
          <div id="emptySearch" class="empty hidden">ì¡°ê±´ì— ë§ëŠ” ê²°ê³¼ê°€ ì—†ì–´ìš”. <b>í•„í„°ë¥¼ ì¡°ì •</b>í•´ ë³´ì„¸ìš”.</div>
        </section>
      </main>

      <!-- ì»¬ë ‰ì…˜ë¶ í™”ë©´ -->
      <main id="view-collection" class="hidden" aria-label="ì»¬ë ‰ì…˜ë¶ í™”ë©´">
        <section class="panel row">
          <div>
            <strong>ğŸ“š ì»¬ë ‰ì…˜ë¶</strong>
            <span class="muted">â€” ì§„í–‰ë¥ ê³¼ í•„ìš” ìˆ˜ëŸ‰ì„ í•œëˆˆì—</span>
          </div>
          <div class="row" style="gap:6px"><!-- import/export ì œê±°ë¨ --></div>
        </section>

        <!-- ì»¬ë ‰ì…˜ë¶ ì „ìš© ì¹´í…Œê³ ë¦¬ -->
        <section class="panel toolbar" aria-label="ì»¬ë ‰ì…˜ ì¹´í…Œê³ ë¦¬">
          <div class="chipbar" id="collectionChips" role="group" aria-label="ì»¬ë ‰ì…˜ ì¹´í…Œê³ ë¦¬"></div>
        </section>

        <section class="panel" aria-label="ì§„í–‰ë¥ ">
          <div class="row" style="gap:16px; align-items:center">
            <div class="row" style="gap:12px">
              <div><small class="muted">ì™„ë£Œìœ¨</small><div id="statRate" style="font-weight:700">0%</div></div>
              <div><small class="muted">ì™„ë£Œ</small><div id="statDone" style="font-weight:700">0</div></div>
              <div><small class="muted">ë‚¨ì€</small><div id="statLeft" style="font-weight:700">0</div></div>
            </div>
            <div class="prog" style="flex:1 1 auto"><span id="progBar" style="width:0%"></span></div>
          </div>
        </section>

        <section class="panel" aria-label="ì»¬ë ‰ì…˜ í…Œì´ë¸”">
          <table class="tbl" id="collectionTable">
            <thead>
              <tr>
                <th style="width:48px">ì™„</th>
                <th>í’ˆëª©</th>
                <th style="width:120px">í•„ìš” ê°¯ìˆ˜</th>
              </tr>
            </thead>
            <tbody id="collectionBody"></tbody>
          </table>
        </section>

        <div class="panel hidden" id="emptyCollection">ì•„ì§ ìˆ˜ì§‘ ëª©ë¡ì´ ì—†ì–´ìš”.</div>

        <div class="row" style="gap:8px">
          <button id="btnBackToSearch" class="btn">â† ê²€ìƒ‰ìœ¼ë¡œ</button>
          <span class="muted">T: ë¬´ì—­ì„¬ ëª¨ë“œ â€¢ C: ì»¬ë ‰ì…˜ë¶ â€¢ F: ì¦ê²¨ì°¾ê¸°ë§Œ â€¢ /: ê²€ìƒ‰ â€¢ M: ë©”ëª¨</span>
        </div>
      </main>
    </div>

    <!-- ìš°ì¸¡: ë©”ëª¨ (ëª¨ë“  í™”ë©´ ê³ ì •) -->
    <aside class="memo" id="memoPane" aria-label="ë©”ëª¨">
      <div class="panel" style="display:flex; flex-direction:column; flex:1">
        <div class="memo-head">
          <strong>ğŸ“ ë©”ëª¨</strong>
          <div class="muted" id="memoSaved">ì €ì¥ë¨</div>
        </div>
        <textarea id="memo" class="memo-box" placeholder="ì—¬ê¸°ì— í•„ìš”í•œ ê³„ì‚°, ë§í¬, ë©”ëª¨ë¥¼ ììœ ë¡­ê²Œ ì ì–´ë‘ì„¸ìš”."></textarea>
        <div class="memo-foot">
          <div class="row" style="gap:8px">
            <button id="btnMemoClear" class="btn ghost" title="ë©”ëª¨ ì§€ìš°ê¸°">ì§€ìš°ê¸°</button>
            <button id="btnMemoExport" class="btn ghost" title="ë©”ëª¨ ë‚´ë³´ë‚´ê¸°">ë‚´ë³´ë‚´ê¸°</button>
            <label class="btn ghost" title="ë©”ëª¨ ê°€ì ¸ì˜¤ê¸°">ê°€ì ¸ì˜¤ê¸° <input id="memoImport" type="file" accept="text/plain" hidden></label>
          </div>
          <span class="muted">M: ë©”ëª¨ í† ê¸€/í¬ì»¤ìŠ¤</span>
        </div>
      </div>
    </aside>
  </div>

  <!-- ê³„ì‚° ëª¨ë‹¬ -->
  <div id="calcModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="calcTitle">
    <div class="backdrop" data-close></div>
    <div class="dialog">
      <div class="row">
        <h3 id="calcTitle">ê°€ê²© ê³„ì‚°</h3>
        <button class="btn ghost" data-close>ë‹«ê¸°</button>
      </div>
      <div id="calcBody" style="display:grid; gap:10px; margin-top:8px">
        <div class="row"><span class="muted">ì§ì—…</span><strong id="calcJob">-</strong></div>
        <div class="row"><span class="muted">ì•„ì´í…œ</span><strong id="calcItem">-</strong></div>
        <div class="row"><span class="muted">ê¸°ì¤€ê°€</span><strong id="calcBase">0</strong></div>
        <label class="row" style="align-items:center">
          <span style="min-width:92px">ë³€ë™ í¼ì„¼íŠ¸</span>
          <input id="calcPct" class="input" type="number" step="1" min="-30" max="80" placeholder="-30 ~ 80" style="width:140px">%
          <small class="muted">(-30% ~ 80% ë²”ìœ„)</small>
        </label>
        <label class="row" style="align-items:center">
          <span style="min-width:92px">ìˆ˜ëŸ‰</span>
          <input id="calcQty" class="input" type="number" step="1" min="1" value="1" style="width:140px">
        </label>
        <div class="row">
          <button id="btnCalc" class="btn">ê³„ì‚°í•˜ê¸°</button>
          <div id="calcResult" style="font-weight:700"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===================== ë°ì´í„° (ìƒ˜í”Œ) =====================
    // ì¹´í…Œê³ ë¦¬ ëª…: ë†ë¶€/ìš”ë¦¬ì‚¬/ê´‘ë¶€/ì–´ë¶€
    const CATEGORIES = ['ì „ì²´','ë†ë¶€','ìš”ë¦¬ì‚¬','ê´‘ë¶€','ì–´ë¶€'];

    // ê²€ìƒ‰/ë¬´ì—­ì„¬ í†µí•© ì•„ì´í…œ (ê¸°ì¤€ê°€ base í¬í•¨)
    const ITEMS = [
      { id: 'i-001', name: 'ë°€ ì´ì‚­', category: 'ë†ë¶€', tier: '1ì°¨', base: 100 },
      { id: 'i-002', name: 'ì‹ ì„ í•œ ìš°ìœ ', category: 'ë†ë¶€', tier: '2ì°¨', base: 220 },
      { id: 'i-003', name: 'êµ¬ìš´ ìƒì„ ', category: 'ì–´ë¶€', tier: '2ì°¨', base: 180 },
      { id: 'i-004', name: 'ë°”ìœ„ ìˆ˜ì •', category: 'ê´‘ë¶€', tier: '3ì°¨', base: 320 },
      { id: 'i-005', name: 'ê³ ê¸‰ ìš”ë¦¬ í‚¤íŠ¸', category: 'ìš”ë¦¬ì‚¬', tier: '4ì°¨', base: 450 },
    ];

    // ì»¬ë ‰ì…˜ ìš”êµ¬ì‚¬í•­ (ì²´í¬ë°•ìŠ¤/í’ˆëª©/í•„ìš” ê°¯ìˆ˜)
    const COLLECTION = [
      { id: 'i-001', need: 3 },
      { id: 'i-004', need: 2 },
      { id: 'i-005', need: 1 },
    ];

    // ===================== ìƒíƒœ/ìŠ¤í† ë¦¬ì§€ =====================
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));
    const load = (k, def) => JSON.parse(localStorage.getItem(k) || JSON.stringify(def));

    const state = { q:'', category:'ì „ì²´', tier:'', favoritesOnly:false, view:'search', mode:'search', collectionCategory:'ì „ì²´' }; // mode: 'search' | 'trade'

    const favKey = 'jetty:favorites';
    const favorites = new Set(load(favKey, []));
    const memoKey = 'jetty:memo';
    const collectionDoneKey = 'jetty:collection:done';
    const collectionDone = new Set(load(collectionDoneKey, []));

    // ===================== ìœ í‹¸ =====================
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
    function fmt(n){ return Number(n).toLocaleString(); }
    function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }
    function stamp(){ return new Intl.DateTimeFormat(undefined,{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(new Date()); }
    function logToMemo(line){ const txt=$('#memo'); txt.value=(txt.value?txt.value+"\n":"")+line; save(memoKey, txt.value); stampSaved(); }

    // ===================== ì´ˆê¸° UI =====================
    function initChips(){ const wrap=$('#catChips'); wrap.innerHTML=''; CATEGORIES.forEach(cat=>{ const b=document.createElement('button'); b.className='chip'; b.type='button'; b.textContent=cat; b.setAttribute('aria-pressed', cat===state.category); b.addEventListener('click',()=>{ state.category=cat; renderSearch(); }); wrap.appendChild(b); }); }
    function initCollectionChips(){ const wrap=document.getElementById('collectionChips'); if(!wrap) return; wrap.innerHTML=''; ['ì „ì²´','ë†ë¶€','ìš”ë¦¬ì‚¬','ê´‘ë¶€','ì–´ë¶€'].forEach(cat=>{ const b=document.createElement('button'); b.className='chip'; b.type='button'; b.textContent=cat; b.setAttribute('aria-pressed', cat===state.collectionCategory); b.addEventListener('click',()=>{ state.collectionCategory=cat; renderCollection(); }); wrap.appendChild(b); }); }

    // ===================== ë Œë”: ê²€ìƒ‰/ë¬´ì—­ì„¬ í†µí•© =====================
    function renderSearch(){
      $('#subtitle').textContent = (state.mode==='trade') ? 'ë¬´ì—­ì„¬' : 'ê²€ìƒ‰';
      $('#view-search').classList.remove('hidden');
      $('#view-collection').classList.add('hidden');
      $('#btnCollection').setAttribute('aria-pressed','false');
      $('#btnTrade').setAttribute('aria-pressed', String(state.mode==='trade'));
      $$('#catChips .chip').forEach(ch=> ch.setAttribute('aria-pressed', ch.textContent===state.category));

      const q=state.q.trim().toLowerCase();
      const list=ITEMS.filter(it=>{
        if(state.category!=='ì „ì²´' && it.category!==state.category) return false;
        if(state.tier && it.tier!==state.tier) return false;
        if(state.favoritesOnly && !favorites.has(it.id)) return false;
        if(q && !it.name.toLowerCase().includes(q)) return false;
        return true;
      });
      const el=$('#list'); el.innerHTML=''; list.forEach(it=> el.appendChild(Card(it))); $('#emptySearch').classList.toggle('hidden', list.length>0);
    }

    // ===================== ë Œë”: ì»¬ë ‰ì…˜ë¶ =====================
    function renderCollection(){
      document.getElementById('subtitle').textContent = 'ì»¬ë ‰ì…˜ë¶';
      document.getElementById('view-search').classList.add('hidden');
      document.getElementById('view-collection').classList.remove('hidden');
      document.getElementById('btnCollection').setAttribute('aria-pressed','true');
      // ì»¬ë ‰ì…˜ë¶ ì§„ì… ì‹œ ì¦ê²¨ì°¾ê¸°ë§Œ ìë™ í•´ì œ
      if(state.favoritesOnly){ state.favoritesOnly=false; document.getElementById('btnFavoritesOnly').setAttribute('aria-pressed','false'); }

      // ì¹© ìƒíƒœ ì—…ë°ì´íŠ¸
      document.querySelectorAll('#collectionChips .chip').forEach(ch=> ch.setAttribute('aria-pressed', ch.textContent===state.collectionCategory));

      // ì¹´í…Œê³ ë¦¬ í•„í„°ë§ëœ í–‰
      const rows = COLLECTION.filter(row=>{
        const prod = ITEMS.find(p=>p.id===row.id);
        if(!prod) return true;
        if(state.collectionCategory!=='ì „ì²´' && prod.category!==state.collectionCategory) return false;
        return true;
      });

      const total=rows.length; const done=rows.filter(r=>collectionDone.has(r.id)).length; const left=total-done; const rate=total? Math.round(done/total*100):0;
      document.getElementById('statRate').textContent=rate+'%';
      document.getElementById('statDone').textContent=String(done);
      document.getElementById('statLeft').textContent=String(left);
      document.getElementById('progBar').style.width=rate+'%';

      const tbody=document.getElementById('collectionBody'); tbody.innerHTML='';
      rows.forEach(row=>{ const prod=ITEMS.find(p=>p.id===row.id) || {name:row.id}; const tr=document.createElement('tr'); const checked=collectionDone.has(row.id);
        tr.innerHTML=`<td><input type="checkbox" ${checked?'checked':''} aria-label="${escapeHtml(prod.name)} ì™„ë£Œ"></td><td>${escapeHtml(prod.name)}</td><td>${row.need}</td>`;
        const cb=tr.querySelector('input'); cb.addEventListener('change',()=>{ if(cb.checked) collectionDone.add(row.id); else collectionDone.delete(row.id); save(collectionDoneKey,[...collectionDone]); renderCollection(); });
        tbody.appendChild(tr);
      });
      document.getElementById('emptyCollection').classList.toggle('hidden', rows.length>0);
    }

    // ===================== ì»´í¬ë„ŒíŠ¸ =====================
    function Card(it){
      const root=document.createElement('article'); root.className='card';
      if(state.mode==='trade') root.classList.add('clickable');
      root.innerHTML=`
        <div class="row">
          <h3>${escapeHtml(it.name)}</h3>
          <div class="row" style="gap:6px">
            <span class="tag">${escapeHtml(it.category)} â€¢ ${escapeHtml(it.tier||'-')}</span>
            <button class="btn ghost fav" aria-label="ì¦ê²¨ì°¾ê¸°" title="ì¦ê²¨ì°¾ê¸°">${favorites.has(it.id)?'â­':'â˜†'}</button>
          </div>
        </div>
        <div class="row muted"><span>ê¸°ì¤€ê°€</span><strong>${fmt(it.base||0)}</strong></div>`;
      // ëª¨ë“œê°€ ë¬´ì—­ì„¬ì´ë©´ ì¹´ë“œ í´ë¦­ ì‹œ ê³„ì‚° íŒì—…
      if(state.mode==='trade') root.addEventListener('click',()=> openCalc(it));
      // ì¦ê²¨ì°¾ê¸° ë²„íŠ¼ í† ê¸€ (ë²„ë¸”ë§ ë§‰ê¸°)
      const favBtn=root.querySelector('.fav');
      favBtn.addEventListener('click',(e)=>{ e.stopPropagation(); if(favorites.has(it.id)) favorites.delete(it.id); else favorites.add(it.id); save(favKey,[...favorites]); favBtn.textContent=favorites.has(it.id)?'â­':'â˜†'; });
      return root;
    }

    // ===================== ê³„ì‚° ëª¨ë‹¬ =====================
    const modal=$('#calcModal');
    function openCalc(item){
      modal.classList.add('open');
      $('#calcJob').textContent = item.category || '-';
      $('#calcItem').textContent = item.name;
      $('#calcBase').textContent = fmt(item.base||0);
      $('#calcPct').value='';
      $('#calcQty').value=1;
      $('#calcResult').textContent='';
      modal.dataset.item = JSON.stringify(item);
    }
    function closeCalc(){ modal.classList.remove('open'); }
    $$('#calcModal [data-close]').forEach(el=> el.addEventListener('click', closeCalc));
    modal.addEventListener('click',(e)=>{ if(e.target.classList.contains('backdrop')) closeCalc(); });

    $('#btnCalc').addEventListener('click',()=>{
      const item=JSON.parse(modal.dataset.item||'{}');
      const base=Number(item.base||0);
      const pct=clamp(parseFloat($('#calcPct').value||'0'), -30, 80);
      const qty=Math.max(1, parseInt($('#calcQty').value||'1',10));
      $('#calcPct').value=pct; // ë²”ìœ„ ë³´ì • ë°˜ì˜
      const unit=Math.round(base*(1+pct/100));
      const total=unit*qty;
      $('#calcResult').textContent=`= ë‹¨ê°€ ${fmt(unit)} Ã— ${qty} â†’ ${fmt(total)}`;
      logToMemo(`[${stamp()}] ë¬´ì—­ì„¬ ê³„ì‚° Â· ${item.category||'-'} Â· ${item.name} Â· ê¸°ì¤€ê°€ ${fmt(base)} Â· ë³€ë™ ${pct}% Â· ìˆ˜ëŸ‰ ${qty} â†’ í•©ê³„ ${fmt(total)}`);
    });

    // ===================== ë©”ëª¨ =====================
    function initMemo(){
      const txt=$('#memo'); const saved=load(memoKey,''); txt.value=saved; let t;
      txt.addEventListener('input',()=>{ clearTimeout(t); t=setTimeout(()=>{ save(memoKey, txt.value); stampSaved(); },300); });
      $('#btnMemoClear').addEventListener('click',()=>{
        if(confirm('ë©”ëª¨ë¥¼ ëª¨ë‘ ì§€ìš¸ê¹Œìš”?')){
          txt.value='';
          try{ localStorage.removeItem(memoKey); }catch(e){}
          save(memoKey,'');
          stampSaved();
        }
      });
      $('#btnMemoExport').addEventListener('click',()=>{ const blob=new Blob([txt.value],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='jetty-memo.txt'; a.click(); URL.revokeObjectURL(a.href); });
      $('#memoImport').addEventListener('change', async (e)=>{ const file=e.target.files?.[0]; if(!file) return; const text=await file.text(); txt.value=text; save(memoKey,text); stampSaved(); e.target.value=''; });
    }
    function stampSaved(){ $('#memoSaved').textContent='ì €ì¥ë¨ Â· '+ new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

    // ===================== ì´ë²¤íŠ¸/ë‹¨ì¶•í‚¤ =====================
    $('#q').addEventListener('input', e=>{ state.q=e.target.value; renderSearch(); });
    $('#tier').addEventListener('change', e=>{ state.tier=e.target.value; renderSearch(); });

    $('#btnFavoritesOnly').addEventListener('click', ()=>{ state.favoritesOnly=!state.favoritesOnly; $('#btnFavoritesOnly').setAttribute('aria-pressed', String(state.favoritesOnly)); renderSearch(); });

    // ì»¬ë ‰ì…˜ / ë¬´ì—­ì„¬ ëª¨ë“œ í† ê¸€
    $('#btnCollection').addEventListener('click', ()=>{ state.view = (state.view==='collection')? 'search' : 'collection'; if(state.view==='collection') renderCollection(); else renderSearch(); syncUrl(); });
    $('#btnBackToSearch').addEventListener('click', ()=>{ state.view='search'; renderSearch(); syncUrl(); });
    $('#btnTrade').addEventListener('click', ()=>{ state.mode = (state.mode==='trade')? 'search' : 'trade'; renderSearch(); syncUrl(); });

    // ë‹¨ì¶•í‚¤
    window.addEventListener('keydown',(e)=>{
      if(e.key==='/'&&document.activeElement!==$('#q')){ e.preventDefault(); $('#q').focus(); }
      if(e.key.toLowerCase()==='f'){ e.preventDefault(); $('#btnFavoritesOnly').click(); }
      if(e.key.toLowerCase()==='c'){ e.preventDefault(); $('#btnCollection').click(); }
      if(e.key.toLowerCase()==='t'){ e.preventDefault(); $('#btnTrade').click(); }
      if(e.key.toLowerCase()==='m'){
        e.preventDefault();
        const isMobile=window.matchMedia('(max-width:960px)').matches;
        if(isMobile){ $('#memoPane').classList.toggle('open'); if($('#memoPane').classList.contains('open')) $('#memo').focus(); }
        else { $('#memo').focus(); }
      }
    });
    $('#btnMemo').addEventListener('click', ()=>{ $('#memoPane').classList.toggle('open'); if($('#memoPane').classList.contains('open')) $('#memo').focus(); });

    // ===================== URL ë™ê¸°í™” =====================
    function syncUrl(){
      const p=new URLSearchParams();
      if(state.q) p.set('q', state.q);
      if(state.category&&state.category!=='ì „ì²´') p.set('cat', state.category);
      if(state.tier) p.set('tier', state.tier);
      if(state.favoritesOnly) p.set('fav','1');
      p.set('view', state.view);
      p.set('mode', state.mode);
      if(state.collectionCategory && state.collectionCategory!=='ì „ì²´') p.set('ccat', state.collectionCategory);
      history.replaceState(null, '', `${location.pathname}?${p.toString()}`);
    }
    function readUrl(){
      const p=new URLSearchParams(location.search);
      state.q=p.get('q')||''; document.getElementById('q').value=state.q;
      state.category=p.get('cat')||'ì „ì²´';
      state.tier=p.get('tier')||''; document.getElementById('tier').value=state.tier;
      state.favoritesOnly=p.get('fav')==='1'; document.getElementById('btnFavoritesOnly').setAttribute('aria-pressed', String(state.favoritesOnly));
      const v=p.get('view'); state.view=(v==='collection')? v : 'search';
      state.mode = (p.get('mode')==='trade')? 'trade' : 'search';
      state.collectionCategory = p.get('ccat') || 'ì „ì²´';
    }

    // ===================== ë¶€íŠ¸ìŠ¤íŠ¸ë© =====================
    function init(){ initChips(); initCollectionChips(); initMemo(); readUrl(); if(state.view==='collection') renderCollection(); else renderSearch(); stampSaved(); }
    init();

    // ===================== ê°„ë‹¨ ëŸ°íƒ€ì„ í…ŒìŠ¤íŠ¸ =====================
    try {
      console.assert(typeof renderSearch === 'function', 'renderSearch must exist');
      console.assert(typeof renderCollection === 'function', 'renderCollection must exist');
      console.assert(document.getElementById('list'), '#list must exist');
      console.assert(document.getElementById('collectionBody'), '#collectionBody must exist');
    } catch (e) { console.error('Self-test failed', e); }
  </script>
</body>
</html>
