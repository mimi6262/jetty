<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>펭귄 서버 검색기 </title>
  <meta name="theme-color" content="#111827" />
  <style>
    :root{ --bg:#0b1220; --panel:#111827; --muted:#6b7280; --txt:#e5e7eb; --brand:#60a5fa; --accent:#34d399; --danger:#f87171; --ring:0 0 0 3px rgba(96,165,250,.35); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--txt)}
    .wrap{max-width:1200px; margin:0 auto; padding:16px}

    header{position:sticky; top:0; z-index:60; backdrop-filter:saturate(1.2) blur(8px); background:linear-gradient(to bottom, rgba(11,18,32,.9), rgba(11,18,32,.4)); border-bottom:1px solid rgba(255,255,255,.06)}
    .h-inner{max-width:1200px; margin:0 auto; padding:12px 16px; display:grid; grid-template-columns:1fr auto; gap:12px; align-items:center}
    .title{display:flex; align-items:center; gap:10px; font-weight:700}
    .title small{font-size:12px; color:var(--muted)}
    .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}

    .btn{appearance:none; border:1px solid rgba(255,255,255,.08); background:var(--panel); color:var(--txt); padding:8px 12px; border-radius:10px; cursor:pointer; display:inline-flex; gap:8px; align-items:center}
    .btn:hover{border-color:rgba(255,255,255,.16)}
    .btn:focus{outline:none; box-shadow:var(--ring)}
    .btn[aria-pressed="true"], .btn.active{border-color:var(--brand); box-shadow:0 0 0 1px rgba(96,165,250,.35) inset}
    .btn.ghost{background:transparent}

    .chipbar{display:flex; gap:6px; flex-wrap:wrap}
    .chip{border:1px solid rgba(255,255,255,.08); padding:6px 10px; border-radius:999px; background:#0e1628; color:#cbd5e1; cursor:pointer}
    .chip[aria-pressed="true"]{border-color:var(--accent); color:#10b981; background:rgba(16,185,129,.08)}

    .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .input{height:36px; padding:0 12px; border:1px solid rgba(255,255,255,.08); background:#0e1628; color:var(--txt); border-radius:10px}
    .input:focus{outline:none; box-shadow:var(--ring)}

    .panel{background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:12px}
    .row{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .muted{color:var(--muted)}
    .tag{display:inline-flex; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.1); font-size:12px; color:#9ca3af}

    .hidden{display:none !important}

    /* 레이아웃: 메인 + 우측 메모 고정 */
    .layout{display:grid; grid-template-columns: 1fr 320px; gap:16px}
    main{display:grid; gap:14px}
    aside.memo{position:sticky; top:84px; height: calc(100vh - 100px); display:flex; flex-direction:column}
    .memo-head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px}
    .memo-box{flex:1; resize:none; width:100%; border-radius:12px; padding:12px; background:#0e1628; border:1px solid rgba(255,255,255,.08); color:var(--txt)}
    .memo-box:focus{outline:none; box-shadow:var(--ring)}
    .memo-foot{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:8px; font-size:12px; color:#9ca3af}

    /* 카드 리스트 */
    .list{display:grid; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); gap:12px}
    .card{background:#0e1628; border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:10px; cursor:default}
    .card.clickable{cursor:pointer}
    .card h3{margin:0; font-size:16px}

    /* 빈 상태 */
    .empty{padding:28px; text-align:center; color:#9ca3af}
    .empty b{color:#e5e7eb}

    /* 테이블 (도감) */
    .tbl{width:100%; border-collapse:separate; border-spacing:0 8px}
    .tbl th, .tbl td{ padding:10px 12px; text-align:left }
    .tbl thead th{ font-size:12px; color:#9ca3af }
    .tbl tbody tr{ background:#0e1628; border:1px solid rgba(255,255,255,.06) }
    .tbl tbody tr td:first-child{ border-radius:10px 0 0 10px }
    .tbl tbody tr td:last-child{ border-radius:0 10px 10px 0 }

    /* 진행바 */
    .prog{height:10px; background:#0e1628; border:1px solid rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
    .prog > span{display:block; height:100%; background:linear-gradient(90deg, var(--accent), var(--brand))}

    /* 모바일: 메모 접기/펼치기 */
    #btnMemo{display:none}
    @media (max-width: 960px){
      .layout{grid-template-columns:1fr}
      aside.memo{position:fixed; right:12px; bottom:12px; top:auto; width: min(540px, calc(100vw - 24px)); height: 50vh; z-index:80; display:none}
      aside.memo.open{display:flex}
      #btnMemo{display:inline-flex}
    }

    /* 모달 */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:90}
    .modal.open{display:flex}
    .backdrop{position:absolute; inset:0; background:rgba(0,0,0,.5)}
    .dialog{position:relative; width:min(480px,90vw); background:var(--panel); border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:16px; box-shadow:0 15px 50px rgba(0,0,0,.45)}
    .dialog h3{margin:0 0 8px 0}
    .dialog .row{gap:12px}
    .dialog .input{width:100%}
  </style>
</head>
<body>
  <header>
    <div class="h-inner" role="group" aria-label="상단 도구막대">
      <div class="title" aria-live="polite">
        <span>🐧 펭귄 서버 검색기</span>
        <small id="subtitle">검색</small>
      </div>
      <div class="controls">
        <!-- 무역섬 버튼은 '검색' 화면을 그대로 사용하되 모드만 전환 -->
        <button id="btnTrade" class="btn" aria-pressed="false" title="무역섬 모드 토글(T)">🏝️ 무역섬</button>
        <button id="btnCollection" class="btn" aria-pressed="false" title="도감 열기(C)">📚 도감</button>
        <button id="btnFavoritesOnly" class="btn ghost" aria-pressed="false" title="즐겨찾기만 보기(F)">⭐ 즐겨찾기만</button>
        <input id="q" class="input" type="search" placeholder="검색 (/)" aria-label="검색">
        <button id="btnMemo" class="btn ghost" title="메모 열기/닫기(M)">📝 메모</button>
      </div>
    </div>
  </header>

  <div class="wrap layout">
    <!-- 좌측: 콘텐츠 (검색/컬렉션) -->
    <div>
      <!-- 검색/무역섬 통합 화면 -->
      <main id="view-search" aria-label="검색 화면">
        <section class="panel toolbar" aria-label="필터">
          <div class="chipbar" id="catChips" role="group" aria-label="카테고리"></div>
          <select id="tier" class="input" title="차수">
            <option value="">전체 차수</option>
            <option>0차</option>
            <option>1차</option>
            <option>2차</option>
            <option>3차</option>
            <option>4차</option>
            <option>5차</option>
          </select>
        </section>

        <section class="panel" aria-label="결과 목록">
          <div id="list" class="list" aria-live="polite"></div>
          <div id="emptySearch" class="empty hidden">조건에 맞는 결과가 없어요. <b>필터를 조정</b>해 보세요.</div>
        </section>
      </main>

      <!-- 도감 화면 -->
      <main id="view-collection" class="hidden" aria-label="도감 화면">
        <section class="panel row">
          <div>
            <strong>📚 도감</strong>
            <span class="muted">— 진행률과 필요 수량을 한눈에</span>
          </div>
          <div class="row" style="gap:6px"><!-- import/export 제거됨 --></div>
        </section>

        <!-- 도감 전용 카테고리 -->
        <section class="panel toolbar" aria-label="컬렉션 카테고리">
          <div class="chipbar" id="collectionChips" role="group" aria-label="컬렉션 카테고리"></div>
        </section>

        <section class="panel" aria-label="진행률">
          <div class="row" style="gap:16px; align-items:center">
            <div class="row" style="gap:12px">
              <div><small class="muted">완료율</small><div id="statRate" style="font-weight:700">0%</div></div>
              <div><small class="muted">완료</small><div id="statDone" style="font-weight:700">0</div></div>
              <div><small class="muted">남은</small><div id="statLeft" style="font-weight:700">0</div></div>
            </div>
            <div class="prog" style="flex:1 1 auto"><span id="progBar" style="width:0%"></span></div>
          </div>
        </section>

        <section class="panel" aria-label="컬렉션 테이블">
          <table class="tbl" id="collectionTable">
            <thead>
              <tr>
                <th style="width:48px">체크</th>
                <th>종류</th>
                <th style="width:120px">필요 갯수</th>
              </tr>
            </thead>
            <tbody id="collectionBody"></tbody>
          </table>
        </section>

        <div class="panel hidden" id="emptyCollection">아직 수집 목록이 없어요.</div>

        <div class="row" style="gap:8px">
          <button id="btnBackToSearch" class="btn">← 검색으로</button>
          <span class="muted">T: 무역섬 모드 • C: 도감 • F: 즐겨찾기만 • /: 검색 • M: 메모</span>
        </div>
      </main>
    </div>

    <!-- 우측: 메모 (모든 화면 고정) -->
    <aside class="memo" id="memoPane" aria-label="메모">
      <div class="panel" style="display:flex; flex-direction:column; flex:1">
        <div class="memo-head">
          <strong>📝 메모</strong>
          <div class="muted" id="memoSaved">저장됨</div>
        </div>
        <textarea id="memo" class="memo-box" placeholder="여기에 필요한 계산, 링크, 메모를 자유롭게 적어두세요."></textarea>
        <div class="memo-foot">
          <div class="row" style="gap:8px">
            <button id="btnMemoClear" class="btn ghost" title="메모 지우기">지우기</button>
            <button id="btnMemoExport" class="btn ghost" title="메모 내보내기">내보내기</button>
            <label class="btn ghost" title="메모 가져오기">가져오기 <input id="memoImport" type="file" accept="text/plain" hidden></label>
          </div>
          <span class="muted">M: 메모 토글/포커스</span>
        </div>
      </div>
    </aside>
  </div>

  <!-- 계산 모달 -->
  <div id="calcModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="calcTitle">
    <div class="backdrop" data-close></div>
    <div class="dialog">
      <div class="row">
        <h3 id="calcTitle">가격 계산</h3>
        <button class="btn ghost" data-close>닫기</button>
      </div>
      <div id="calcBody" style="display:grid; gap:10px; margin-top:8px">
        <div class="row"><span class="muted">직업</span><strong id="calcJob">-</strong></div>
        <div class="row"><span class="muted">아이템</span><strong id="calcItem">-</strong></div>
        <div class="row"><span class="muted">기준가</span><strong id="calcBase">0</strong></div>
        <label class="row" style="align-items:center">
          <span style="min-width:92px">변동 퍼센트</span>
          <input id="calcPct" class="input" type="number" step="1" min="-30" max="80" placeholder="-30 ~ 80" style="width:140px">%
          <small class="muted">(-30% ~ 80% 범위)</small>
        </label>
        <label class="row" style="align-items:center">
          <span style="min-width:92px">수량</span>
          <input id="calcQty" class="input" type="number" step="1" min="1" value="1" style="width:140px">
        </label>
        <div class="row">
          <button id="btnCalc" class="btn">계산하기</button>
          <div id="calcResult" style="font-weight:700"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===================== 데이터  =====================
    // 무역섬(검색) 카테고리: 농부/요리사/광부/어부
    const CATEGORIES = ['전체','농부','요리사','광부','어부'];

    // 검색/무역섬 통합 아이템 (기준가 base 포함)
    const ITEMS = [

      // 요리사 
        { id: 'i-001', name:'갈릭 스테이크',   category:'요리사', tier:'0차',  base: 50 },
        { id: 'i-002', name:'배추 김치',       category:'요리사', tier:'0차',  base: 78 },
        { id: 'i-003', name:'레몬 당고',       category:'요리사', tier:'0차',  base: 48 },
        { id: 'i-004', name:'요리사코인',         category:'요리사', tier:'0차', base: 1200 },
      
        { id: 'i-005', name:'딸기모찌',           category:'요리사', tier:'1차',  base: 58 },
        { id: 'i-006', name:'오이무침',           category:'요리사', tier:'1차',  base: 86 },
        { id: 'i-007', name:'샐러드',             category:'요리사', tier:'1차',  base: 98 },
        { id: 'i-008', name:'해파리냉채',         category:'요리사', tier:'1차',  base: 1420 },
        { id: 'i-009', name:'고구마 샐러드',      category:'요리사', tier:'1차',  base: 98 },
      
        { id: 'i-010', name:'깍두기',             category:'요리사', tier:'2차',  base: 100 },
        { id: 'i-011', name:'오렌지 푸딩',        category:'요리사', tier:'2차',  base: 72 },
        { id: 'i-012', name:'애호박 찌개',        category:'요리사', tier:'2차',  base: 112 },
        { id: 'i-013', name:'숭어 매운탕',        category:'요리사', tier:'2차',  base: 1420 },
      
        { id: 'i-014', name:'브로콜리 샐러드',    category:'요리사', tier:'3차',  base: 142 },
        { id: 'i-015', name:'토마토 파스타',      category:'요리사', tier:'3차',  base: 130 },
        { id: 'i-016', name:'복숭아 아이스티',    category:'요리사', tier:'3차',  base: 80 },
        { id: 'i-017', name:'철판 새우',          category:'요리사', tier:'3차',  base: 1610 },
      
        { id: 'i-018', name:'메론빵',             category:'요리사', tier:'4차',  base: 90 },
        { id: 'i-019', name:'김밥',               category:'요리사', tier:'4차',  base: 166 },
        { id: 'i-020', name:'비빔밥',             category:'요리사', tier:'4차',  base: 166 },
        { id: 'i-021', name:'생선 튀김',          category:'요리사', tier:'4차',  base: 1610 },

    //농부
         { id: 'i-1000', name:'농부코인',       category:'농부', tier:'0차', base:1200 },
        { id: 'i-1001', name:'1등급 마늘',     category:'농부', tier:'0차', base:24 },
        { id: 'i-1002', name:'1등급 배추',     category:'농부', tier:'0차', base:24 },
        { id: 'i-1003', name:'1등급 고추',     category:'농부', tier:'0차', base:24 },
        { id: 'i-1004', name:'1등급 레몬',     category:'농부', tier:'0차', base:24 },
        { id: 'i-1005', name:'황금 마늘',      category:'농부', tier:'0차', base:100 },
        { id: 'i-1006', name:'황금 배추',      category:'농부', tier:'0차', base:100 },
        { id: 'i-1007', name:'황금 레몬',      category:'농부', tier:'0차', base:100 },
      
        { id: 'i-1008', name:'1등급 고구마',    category:'농부', tier:'1차', base:30 },
        { id: 'i-1009', name:'1등급 파프리카',  category:'농부', tier:'1차', base:30 },
        { id: 'i-1010', name:'1등급 오이',     category:'농부', tier:'1차', base:30 },
        { id: 'i-1011', name:'1등급 딸기',     category:'농부', tier:'1차', base:30 },
        { id: 'i-1012', name:'황금 고구마',    category:'농부', tier:'1차', base:200 },
        { id: 'i-1013', name:'황금 파프리카',  category:'농부', tier:'1차', base:200 },
        { id: 'i-1014', name:'황금 오이',      category:'농부', tier:'1차', base:200 },
        { id: 'i-1015', name:'황금 딸기',      category:'농부', tier:'1차', base:200 },
      
        { id: 'i-1016', name:'1등급 애호박',   category:'농부', tier:'2차', base:36 },
        { id: 'i-1017', name:'1등급 대파',     category:'농부', tier:'2차', base:36 },
        { id: 'i-1018', name:'1등급 무',       category:'농부', tier:'2차', base:36 },
        { id: 'i-1019', name:'1등급 오렌지',   category:'농부', tier:'2차', base:36 },
        { id: 'i-1020', name:'황금 애호박',    category:'농부', tier:'2차', base:300 },
        { id: 'i-1021', name:'황금 대파',      category:'농부', tier:'2차', base:300 },
        { id: 'i-1022', name:'황금 무',        category:'농부', tier:'2차', base:300 },
        { id: 'i-1023', name:'황금 오렌지',    category:'농부', tier:'2차', base:300 },
      
        { id: 'i-1024', name:'1등급 토마토',   category:'농부', tier:'3차', base:42 },
        { id: 'i-1025', name:'1등급 양배추',   category:'농부', tier:'3차', base:42 },
        { id: 'i-1026', name:'1등급 브로콜리', category:'농부', tier:'3차', base:42 },
        { id: 'i-1027', name:'1등급 복숭아',   category:'농부', tier:'3차', base:42 },
        { id: 'i-1028', name:'황금 토마토',    category:'농부', tier:'3차', base:400 },
        { id: 'i-1029', name:'황금 양배추',    category:'농부', tier:'3차', base:400 },
        { id: 'i-1030', name:'황금 브로콜리',  category:'농부', tier:'3차', base:400 },
        { id: 'i-1031', name:'황금 복숭아',    category:'농부', tier:'3차', base:400 },
      
        { id: 'i-1032', name:'1등급 상추',     category:'농부', tier:'4차', base:48 },
        { id: 'i-1033', name:'1등급 씰',       category:'농부', tier:'4차', base:48 },
        { id: 'i-1034', name:'1등급 양파',     category:'농부', tier:'4차', base:48 },
        { id: 'i-1035', name:'1등급 멜론',     category:'농부', tier:'4차', base:48 },
        { id: 'i-1036', name:'황금 상추',      category:'농부', tier:'4차', base:500 },
        { id: 'i-1037', name:'황금 쌀',        category:'농부', tier:'4차', base:500 },
        { id: 'i-1038', name:'황금 양파',      category:'농부', tier:'4차', base:500 },
        { id: 'i-1039', name:'황금 멜론',      category:'농부', tier:'4차', base:500 },
      
// 어부
      { id: 'i-2000', name:'어부코인',         category:'어부', tier:'0차', base:1200 },
      { id: 'i-2001', name:'1등급 조개 껍데기', category:'어부', tier:'3차', base:360 },
      { id: 'i-2002', name:'1등급 해마',        category:'어부', tier:'3차', base:360 },
      { id: 'i-2003', name:'1등급 블롭',        category:'어부', tier:'3차', base:360 },
      { id: 'i-2004', name:'1등급 가오리',      category:'어부', tier:'3차', base:360 },
      { id: 'i-2005', name:'1등급 참치',        category:'어부', tier:'3차', base:360 },
      { id: 'i-2006', name:'1등급 아귀',        category:'어부', tier:'3차', base:360 },
      { id: 'i-2007', name:'1등급 돌 가오리',   category:'어부', tier:'3차', base:360 },
      { id: 'i-2008', name:'1등급 딸기 블롭',   category:'어부', tier:'3차', base:360 },
      { id: 'i-2009', name:'1등급 소라게',      category:'어부', tier:'3차', base:360 },
      { id: 'i-2010', name:'1등급 거북이',      category:'어부', tier:'3차', base:1068 },
      { id: 'i-2011', name:'1등급 보리새우',    category:'어부', tier:'3차', base:1068 },
      { id: 'i-2012', name:'1등급 아기상어',    category:'어부', tier:'3차', base:1355 },
      { id: 'i-2013', name:'1등급 진주품은 조개', category:'어부', tier:'3차', base:1355 },
    
      { id: 'i-2014', name:'바다 램프',        category:'어부', tier:'4차', base:1850 },
      { id: 'i-2015', name:'도금 동전',        category:'어부', tier:'4차', base:1850 },
      { id: 'i-2016', name:'닫힌 보물상자',     category:'어부', tier:'4차', base:1850 },
      { id: 'i-2017', name:'수상한 보물상자',   category:'어부', tier:'4차', base:1850 },
      { id: 'i-2018', name:'보물상자',         category:'어부', tier:'4차', base:1850 },
      { id: 'i-2019', name:'편지가 든 유리병',  category:'어부', tier:'4차', base:1850 },
      { id: 'i-2020', name:'물고기 유리병',     category:'어부', tier:'4차', base:1850 },
      { id: 'i-2021', name:'메갈로돈 이빨',     category:'어부', tier:'4차', base:1850 },
      { id: 'i-2022', name:'배키',             category:'어부', tier:'4차', base:1850 },
      { id: 'i-2023', name:'앵커',             category:'어부', tier:'4차', base:1850 },
      
      { id: 'i-2024', name:'오징어 텐터클',     category:'어부', tier:'0차', base:2000 },
      { id: 'i-2025', name:'돌고래 꼬리',       category:'어부', tier:'0차', base:2000 },
      { id: 'i-2026', name:'게 비늘',          category:'어부', tier:'0차', base:1500 },
      { id: 'i-2027', name:'게 발톱',          category:'어부', tier:'0차', base:1500 },

//광부
       { id: 'i-3000', name:'광부코인',       category:'광부', tier:'0차', base:1200 },
      { id: 'i-3001', name:'다이아',         category:'광부', tier:'0차', base:72 },
      { id: 'i-3002', name:'금',             category:'광부', tier:'0차', base:15 },
      { id: 'i-3003', name:'철',             category:'광부', tier:'0차', base:10 },
      { id: 'i-3004', name:'구리',           category:'광부', tier:'0차', base:4 },
      { id: 'i-3005', name:'청금석',         category:'광부', tier:'0차', base:6 },
      { id: 'i-3006', name:'레드스톤',       category:'광부', tier:'0차', base:6 },
      { id: 'i-3007', name:'에메랄드',       category:'광부', tier:'0차', base:120 },
      { id: 'i-3008', name:'석영',           category:'광부', tier:'0차', base:8 },
      { id: 'i-3009', name:'네더라이트',     category:'광부', tier:'0차', base:200 },
      { id: 'i-3010', name:'신비로운 스피넬', category:'광부', tier:'0차', base:150 },
      { id: 'i-3011', name:'신비로운 태양석', category:'광부', tier:'0차', base:500 },
      { id: 'i-3012', name:'신비로운 루비',   category:'광부', tier:'0차', base:1800 },
      { id: 'i-3013', name:'신비로운 크리스탈', category:'광부', tier:'0차', base:12000 },
      { id: 'i-3014', name:'다이아 블록',       category:'광부', tier:'0차', base:720 },
      
      { id: 'i-3015', name:'금 블록',           category:'광부', tier:'0차', base:150 },
      { id: 'i-3016', name:'철 블록',           category:'광부', tier:'0차', base:100 },
      { id: 'i-3017', name:'구리 블록',         category:'광부', tier:'0차', base:40 },
      { id: 'i-3018', name:'청금석 블록',       category:'광부', tier:'0차', base:60 },
      { id: 'i-3019', name:'레드스톤 블록',     category:'광부', tier:'0차', base:60 },
      { id: 'i-3020', name:'에메랄드 블록',     category:'광부', tier:'0차', base:1200 },
      { id: 'i-3021', name:'네더라이트 블록',   category:'광부', tier:'0차', base:2000 },
      
    ];

    // 컬렉션 요구사항 (체크박스/품목/필요 갯수) — 컬렉션 전용 카테고리(ccat)
    const COLLECTION = [
    
     
      { id:'c-dirt',       need:64,    name:'흙',        ccat:'블록' },
      { id:'c-coarse_dirt',  need:64,  name:'거친 흙',    ccat:'블록' },
      { id:'c-podzol',       need:64,  name:'포드졸',     ccat:'블록' },
      { id:'c-rooted_dirt',  need:64,  name:'뿌리내린 흙', ccat:'블록' },
      { id:'c-mud',         need:64,   name:'진흙',       ccat:'블록' },
      { id:'c-clay',       need:64,    name:'점토',       ccat:'블록' },
      { id:'c-gravel',      need:64,   name:'자갈',       ccat:'블록' },
      { id:'c-sand',        need:64,   name:'모래',       ccat:'블록' },
      { id:'c-stone',        need:64, name:'돌',         ccat:'블록' },
      { id:'c-andesite',     need:64, name:'안산암',     ccat:'블록' },
      { id:'c-diorite',      need:64, name:'섬록암',     ccat:'블록' },
      { id:'c-sand',         need:64, name:'모래',       ccat:'블록' },
      { id:'c-sandstone',    need:64, name:'사암',       ccat:'블록' },
      { id:'c-red_sand',     need:64, name:'붉은 모래',  ccat:'블록' },
      { id:'c-red_sandstone',need:64, name:'붉은 사암',  ccat:'블록' },
      { id:'c-ice',          need:64, name:'얼음',       ccat:'블록' },
      { id:'c-packed_ice',      need:64, name:'꽁꽁 언 얼음',      ccat:'블록' },
      { id:'c-blue_ice',        need:64, name:'푸른 얼음',        ccat:'블록' },
      { id:'c-snow_block',      need:64, name:'눈 블록',          ccat:'블록' },
      { id:'c-moss_block',      need:64, name:'이끼 블록',        ccat:'블록' },
      { id:'c-mossy_cobblestone',need:64, name:'이끼 낀 조약돌', ccat:'블록' },
      { id:'c-cobblestone',     need:64, name:'조약돌',          ccat:'블록' },
      { id:'c-deepslate',       need:64, name:'심층암',          ccat:'블록' },
      { id:'c-granite',           need:64, name:'화강암',           ccat:'블록' },
      { id:'c-diorite',           need:64, name:'섬록암',           ccat:'블록' },
      { id:'c-andesite',          need:64, name:'안산암',           ccat:'블록' },
      { id:'c-calcite',           need:64, name:'석회암',           ccat:'블록' },
      { id:'c-tuff',              need:64, name:'응회암',           ccat:'블록' },
      { id:'c-dripstone_block',   need:64, name:'점적석 블록',      ccat:'블록' },
      { id:'c-smooth_quartz',     need:64, name:'매끄러운 석영 블록',ccat:'블록' },
      { id:'c-prismarine',         need:64, name:'프리즈마린',        ccat:'블록' },
      { id:'c-magma_block',        need:64, name:'마그마 블록',        ccat:'블록' },
      { id:'c-netherrack',         need:64, name:'네더랙',            ccat:'블록' },
      { id:'c-crimson_nylium',     need:64, name:'진홍빛 균사',       ccat:'블록' },
      { id:'c-warped_nylium',      need:64, name:'뒤틀린 균사',       ccat:'블록' },
      { id:'c-mud',                need:64, name:'진흙',              ccat:'블록' },
      { id:'c-packed_mud',         need:64, name:'굳은 진흙',         ccat:'블록' },
      { id:'c-mud_bricks',         need:64, name:'진흙 벽돌',         ccat:'블록' },
            { id:'c-bone_block',         need:64, name:'뼛가루 블록',       ccat:'블록' },
      { id:'c-blackstone',         need:64, name:'흑석',              ccat:'블록' },
      { id:'c-basalt',             need:64, name:'현무암',            ccat:'블록' },
      { id:'c-smooth_basalt',      need:64, name:'매끄러운 현무암',   ccat:'블록' },
      { id:'c-stripped_oak_log',   need:64, name:'껍질 벗긴 참나무',  ccat:'블록' },
      { id:'c-stripped_spruce_log',need:64, name:'껍질 벗긴 가문비나무',ccat:'블록' },
      { id:'c-stripped_birch_log', need:64, name:'껍질 벗긴 자작나무', ccat:'블록' },
      { id:'c-birch_log',          need:64, name:'자작나무 원목',      ccat:'블록' },
            { id:'c-oak_log',            need:64, name:'참나무 원목',       ccat:'블록' },
      { id:'c-dark_oak_log',       need:64, name:'짙은 참나무 원목',  ccat:'블록' },
      { id:'c-spruce_log',         need:64, name:'가문비나무 원목',   ccat:'블록' },
      { id:'c-crimson_stem',       need:64, name:'진홍빛 자루',       ccat:'블록' },
      { id:'c-warped_stem',        need:64, name:'뒤틀린 자루',       ccat:'블록' },
      { id:'c-mangrove_log',       need:64, name:'맹그로브 원목',     ccat:'블록' },
      { id:'c-cherry_log',         need:64, name:'벚나무 원목',       ccat:'블록' },
      { id:'c-stripped_cherry_log',need:64, name:'껍질 벗긴 벚나무',  ccat:'블록' },
            { id:'c-warped_wart_block',  need:64, name:'뒤틀린 사마귀 블록', ccat:'블록' },
      { id:'c-oak_leaves',         need:64, name:'참나무 잎',        ccat:'블록' },
      { id:'c-dark_oak_leaves',    need:64, name:'짙은 참나무 잎',   ccat:'블록' },
      { id:'c-spruce_leaves',      need:64, name:'가문비나무 잎',    ccat:'블록' },
      { id:'c-birch_leaves',       need:64, name:'자작나무 잎',      ccat:'블록' },
      { id:'c-jungle_leaves',      need:64, name:'정글나무 잎',      ccat:'블록' },
      { id:'c-acacia_leaves',      need:64, name:'아카시아 잎',      ccat:'블록' },
      { id:'c-purple_block',       need:64, name:'페퍼 블록',        ccat:'블록' },

//자연
      { id:'c-brown_mushroom',   need:64, name:'갈색 버섯',    ccat:'자연' },
      { id:'c-red_mushroom',     need:64, name:'빨간 버섐',    ccat:'자연' },
      { id:'c-crimson_fungus',   need:64, name:'진홍빛 버섯',  ccat:'자연' },
      { id:'c-warped_fungus',    need:64, name:'뒤틀린 버섯',  ccat:'자연' },
      { id:'c-dandelion',        need:32, name:'민들레',       ccat:'자연' },
      { id:'c-poppy',            need:32, name:'양귀비',       ccat:'자연' },
      { id:'c-blue_orchid',      need:32, name:'파란 난초',    ccat:'자연' },
      { id:'c-allium',         need:32, name:'올리엄',       ccat:'자연' },
      { id:'c-red_tulip',      need:32, name:'빨간 튤립',    ccat:'자연' },
      { id:'c-orange_tulip',   need:32, name:'주황 튤립',    ccat:'자연' },
      { id:'c-white_tulip',    need:32, name:'흰 튤립',     ccat:'자연' },
      { id:'c-pink_tulip',     need:32, name:'분홍 튤립',   ccat:'자연' },
      { id:'c-wither_rose',    need:8,  name:'위더 장미',    ccat:'자연' },
      { id:'c-rose_bush',       need:3,  name:'장미 관목',       ccat:'자연' },
      { id:'c-oxeye_daisy',     need:32, name:'데이지',         ccat:'자연' },
      { id:'c-dandelion_white', need:32, name:'수선화',         ccat:'자연' },   // 실제 명칭: 아네모네(1.21)
      { id:'c-lily_of_the_valley', need:32, name:'은방울꽃',    ccat:'자연' },
      { id:'c-sunflower',       need:8,  name:'해바라기',       ccat:'자연' },
      { id:'c-pink_petals',     need:32, name:'벚꽃 잎',       ccat:'자연' },
      { id:'c-dead_bush',       need:4,  name:'마른 덤불',      ccat:'자연' },
      { id:'c-beetroot',      need:64, name:'비트',        ccat:'자연' },
      { id:'c-wheat_seeds',   need:64, name:'씨앗',        ccat:'자연' },
      { id:'c-cactus',        need:64, name:'선인장',      ccat:'자연' },
      { id:'c-sugar_cane',    need:64, name:'사탕수수',    ccat:'자연' },
      { id:'c-bamboo',        need:64, name:'대나무',      ccat:'자연' },
      { id:'c-string',        need:16, name:'실',         ccat:'자연' },
            { id:'c-fern',           need:32, name:'고사리',          ccat:'자연' },
      { id:'c-glow_lichen',    need:32, name:'발광 이끼',       ccat:'자연' },
      { id:'c-sweet_berries',  need:64, name:'스위트 베리',     ccat:'자연' },
      { id:'c-glow_berries',   need:64, name:'발광 베리',       ccat:'자연' },
      { id:'c-cocoa_beans',    need:64, name:'코코아콩',        ccat:'자연' },
      { id:'c-hanging_roots',  need:3,  name:'매달린 뿌리',     ccat:'자연' },
      { id:'c-tropical_fish',     need:3,  name:'열대어',            ccat:'자연' },
      { id:'c-turtle_egg',        need:3,  name:'거북 알',           ccat:'자연' },
      { id:'c-pumpkin',           need:32, name:'호박',              ccat:'자연' },
      { id:'c-carved_pumpkin',    need:32, name:'조각된 호박',       ccat:'자연' },
      { id:'c-melon',             need:32, name:'수박',              ccat:'자연' },
      { id:'c-cobblestone',       need:32, name:'조약돌',            ccat:'자연' },
      { id:'c-mossy_cobblestone', need:32, name:'이끼 낀 조약돌',    ccat:'자연' },
            { id:'c-orange_wool', need:32, name:'주황 양털',   ccat:'자연' },
      { id:'c-red_wool',    need:32, name:'빨간 양털',   ccat:'자연' },
      { id:'c-pink_wool',   need:32, name:'분홍 양털',   ccat:'자연' },
      { id:'c-blue_wool',   need:32, name:'파란 양털',   ccat:'자연' },
      { id:'c-blue_dye',    need:16, name:'청색 염료',   ccat:'자연' },
      { id:'c-gray_dye',    need:16, name:'회색 염료',   ccat:'자연' },
      { id:'c-black_dye',   need:16, name:'검정 염료',   ccat:'자연' },
            { id:'c-brown_mushroom_block', need:16, name:'갈색 버섯 블록',  ccat:'자연' },
      { id:'c-red_mushroom_block',   need:16, name:'빨간 버섯 블록',  ccat:'자연' },
      { id:'c-orange_dye',     need:16, name:'주황 염료',   ccat:'자연' },
      { id:'c-yellow_dye',     need:16, name:'노란 염료',   ccat:'자연' },
      { id:'c-lime_dye',       need:16, name:'연두 염료',   ccat:'자연' },
      { id:'c-light_blue_dye', need:16, name:'하늘 염료',   ccat:'자연' },
      { id:'c-purple_dye',     need:16, name:'보라 염료',   ccat:'자연' },
      { id:'c-blue_dye',   need:16, name:'청색 염료',  ccat:'자연' },
      { id:'c-green_dye',  need:16, name:'녹색 염료',  ccat:'자연' },
      { id:'c-purple_dye', need:16, name:'보라 염료',  ccat:'자연' },
      { id:'c-cyan_dye',   need:16, name:'청록 염료',  ccat:'자연' },
      { id:'c-pink_dye',   need:16, name:'분홍 염료',  ccat:'자연' },
      { id:'c-cookie',     need:16, name:'쿠키',      ccat:'자연' },
      { id:'c-bread',      need:16, name:'빵',        ccat:'자연' },
            { id:'c-cake',           need:32, name:'케이크',          ccat:'자연' },
      { id:'c-oak_sapling',    need:32, name:'참나무 묘목',     ccat:'자연' },
      { id:'c-spruce_sapling', need:32, name:'가문비 묘목',     ccat:'자연' },
      { id:'c-birch_sapling',  need:32, name:'자작나무 묘목',   ccat:'자연' },
      { id:'c-jungle_sapling', need:32, name:'정글나무 묘목',   ccat:'자연' },
      { id:'c-acacia_sapling', need:32, name:'아카시아 묘목',   ccat:'자연' },
      { id:'c-dark_oak_sapling', need:32, name:'짙은 참나무 묘목', ccat:'자연' },
            { id:'c-cherry_leaves', need:32, name:'벚꽃 잎',       ccat:'자연' },
      { id:'c-warped_roots',  need:32, name:'뒤틀린 뿌리',   ccat:'자연' },

  //광물
      { id:'c-coal_ore',        need:64, name:'석탄 광석',        ccat:'광물' },
      { id:'c-iron_ore',        need:64, name:'철 광석',          ccat:'광물' },
      { id:'c-copper_ore',      need:64, name:'구리 광석',        ccat:'광물' },
      { id:'c-gold_ore',        need:64, name:'금 광석',          ccat:'광물' },
      { id:'c-redstone_ore',    need:64, name:'레드스톤 광석',    ccat:'광물' },
      { id:'c-lapis_ore',       need:8,  name:'청금석 광석',      ccat:'광물' },
      { id:'c-emerald_ore',     need:8,  name:'에메랄드 광석',    ccat:'광물' },
      { id:'c-deepslate_diamond_ore',    need:8,  name:'심층암 다이아몬드 광석',     ccat:'광물' },
      { id:'c-deepslate_coal_ore',       need:3,  name:'심층암 석탄 광석',          ccat:'광물' },
      { id:'c-deepslate_iron_ore',       need:16, name:'심층암 철 광석',           ccat:'광물' },
      { id:'c-deepslate_copper_ore',     need:16, name:'심층암 구리 광석',         ccat:'광물' },
      { id:'c-deepslate_gold_ore',       need:16, name:'심층암 금 광석',           ccat:'광물' },
      { id:'c-deepslate_redstone_ore',   need:64, name:'심층암 레드스톤 광석',     ccat:'광물' },
      { id:'c-deepslate_lapis_ore',      need:64, name:'심층암 청금석 광석',       ccat:'광물' },
      { id:'c-deepslate_emerald_ore',   need:3,  name:'심층암 에메랄드 광석',   ccat:'광물' },
      { id:'c-deepslate_diamond_ore',   need:16, name:'심층암 다이아몬드 광석', ccat:'광물' },
      { id:'c-nether_gold_ore',         need:64, name:'네더 금 광석',          ccat:'광물' },
      { id:'c-nether_quartz_ore',       need:64, name:'네더 석영 광석',        ccat:'광물' },
      { id:'c-nether_bricks',           need:3,  name:'네더 벽돌',             ccat:'광물' },
      { id:'c-weathered_copper',        need:64, name:'산화된 구리 블록',        ccat:'광물' },
      { id:'c-amethyst_block',          need:64, name:'자수정 블록',           ccat:'광물' },
      { id:'c-mud_bricks',     need:64, name:'머드 브릭',     ccat:'광물' },
      { id:'c-coal',           need:64, name:'석탄',           ccat:'광물' },
      { id:'c-copper_ingot',   need:64, name:'구리 주괴',      ccat:'광물' },
      { id:'c-iron_ingot',     need:64, name:'철 주괴',        ccat:'광물' },
      { id:'c-gold_ingot',     need:64, name:'금 주괴',        ccat:'광물' },
      { id:'c-lapis_lazuli',   need:64, name:'청금석',         ccat:'광물' },
      { id:'c-redstone',       need:64, name:'레드스톤',       ccat:'광물' },
      { id:'c-diamond',                 need:32, name:'다이아몬드',            ccat:'광물' },
      { id:'c-emerald',                 need:32, name:'에메랄드',              ccat:'광물' },
      { id:'c-netherite_ingot',         need:3,  name:'네더라이트 주괴',       ccat:'광물' },
      { id:'c-prismarine',              need:32, name:'프리즈마린',            ccat:'광물' },
      { id:'c-prismarine_bricks',       need:32, name:'프리즈마린 벽돌',       ccat:'광물' },
      { id:'c-dark_prismarine',         need:32, name:'다크 프리즈마린',       ccat:'광물' },
      { id:'c-cut_copper',              need:32, name:'절단된 구리',           ccat:'광물' },
      { id:'c-exposed_cut_copper',      need:32, name:'노출된 절단된 구리',    ccat:'광물' },
      { id:'c-weathered_cut_copper',    need:32, name:'풍화된 절단된 구리',    ccat:'광물' },
      { id:'c-oxidized_cut_copper',     need:32, name:'산화된 절단된 구리',    ccat:'광물' },
      { id:'c-raw_copper_block',        need:8,  name:'원시 구리 블록',        ccat:'광물' },
      { id:'c-raw_gold_block',          need:8,  name:'원시 금 블록',          ccat:'광물' },
      { id:'c-raw_iron_block',          need:8,  name:'원시 철 블록',          ccat:'광물' },


      

    




      






      

      

      
 
    ];

    // ===================== 상태/스토리지 =====================
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));
    const load = (k, def) => JSON.parse(localStorage.getItem(k) || JSON.stringify(def));

    // mode: 'search' | 'trade'; collectionCategory: '전체'|'블록'|'자연'|'광물'|'전리품'|'커스텀'
    const state = { q:'', category:'전체', tier:'', favoritesOnly:false, view:'search', mode:'search', collectionCategory:'전체' };

    const favKey = 'jetty:favorites';
    const favorites = new Set(load(favKey, []));
    const memoKey = 'jetty:memo';
    const collectionDoneKey = 'jetty:collection:done';
    const collectionDone = new Set(load(collectionDoneKey, []));

    // ===================== 유틸 =====================
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
    function fmt(n){ return Number(n).toLocaleString(); }
    function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }
    function stamp(){ return new Intl.DateTimeFormat(undefined,{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(new Date()); }
    function logToMemo(line){ const txt=$('#memo'); txt.value=(txt.value?txt.value+"\n":"")+line; save(memoKey, txt.value); stampSaved(); }

    // ===================== 초기 UI =====================
    function initChips(){
      const wrap=$('#catChips');
      wrap.innerHTML='';
      CATEGORIES.forEach(cat=>{
        const b=document.createElement('button');
        b.className='chip';
        b.type='button';
        b.textContent=cat;
        b.setAttribute('aria-pressed', cat===state.category);
        b.addEventListener('click',()=>{ state.category=cat; renderSearch(); });
        wrap.appendChild(b);
      });
    }

    function initCollectionChips(){
      const wrap=document.getElementById('collectionChips');
      if(!wrap) return;
      wrap.innerHTML='';
      ['전체','블록','자연','광물','전리품','커스텀'].forEach(cat=>{
        const b=document.createElement('button');
        b.className='chip';
        b.type='button';
        b.textContent=cat;
        b.setAttribute('aria-pressed', cat===state.collectionCategory);
        b.addEventListener('click',()=>{ state.collectionCategory=cat; renderCollection(); });
        wrap.appendChild(b);
      });
    }

    // ===================== 렌더: 검색/무역섬 통합 =====================
    function renderSearch(){
      $('#subtitle').textContent = (state.mode==='trade') ? '무역섬' : '검색';
      $('#view-search').classList.remove('hidden');
      $('#view-collection').classList.add('hidden');
      $('#btnCollection').setAttribute('aria-pressed','false');
      $('#btnTrade').setAttribute('aria-pressed', String(state.mode==='trade'));
      $$('#catChips .chip').forEach(ch=> ch.setAttribute('aria-pressed', ch.textContent===state.category));

      const q=state.q.trim().toLowerCase();
      const list=ITEMS.filter(it=>{
        if(state.category!=='전체' && it.category!==state.category) return false;
        if(state.tier && it.tier!==state.tier) return false;
        if(state.favoritesOnly && !favorites.has(it.id)) return false;
        if(q && !it.name.toLowerCase().includes(q)) return false;
        return true;
      });
      const el=$('#list'); el.innerHTML=''; list.forEach(it=> el.appendChild(Card(it))); $('#emptySearch').classList.toggle('hidden', list.length>0);
    }

    // ===================== 렌더: 도감 =====================
    function renderCollection(){
      document.getElementById('subtitle').textContent = '도감';
      document.getElementById('view-search').classList.add('hidden');
      document.getElementById('view-collection').classList.remove('hidden');
      document.getElementById('btnCollection').setAttribute('aria-pressed','true');
      // 도감 진입 시 즐겨찾기만 자동 해제
      if(state.favoritesOnly){ state.favoritesOnly=false; document.getElementById('btnFavoritesOnly').setAttribute('aria-pressed','false'); }

      // 칩 상태 업데이트
      document.querySelectorAll('#collectionChips .chip').forEach(ch=> ch.setAttribute('aria-pressed', ch.textContent===state.collectionCategory));

      // 카테고리 필터링된 행 (컬렉션 전용 카테고리를 사용)
      const rows = COLLECTION.filter(row=>{
        if(state.collectionCategory!=='전체' && (row.ccat||'').trim()!==state.collectionCategory) return false;
        return true;
      });

      const total=rows.length; const done=rows.filter(r=>collectionDone.has(r.id)).length; const left=total-done; const rate=total? Math.round(done/total*100):0;
      document.getElementById('statRate').textContent=rate+'%';
      document.getElementById('statDone').textContent=String(done);
      document.getElementById('statLeft').textContent=String(left);
      document.getElementById('progBar').style.width=rate+'%';

      const tbody=document.getElementById('collectionBody'); tbody.innerHTML='';
      rows.forEach(row=>{ const prod=ITEMS.find(p=>p.id===row.id); const name = row.name || (prod&&prod.name) || row.id; const tr=document.createElement('tr'); const checked=collectionDone.has(row.id);
        tr.innerHTML=`<td><input type="checkbox" ${checked?'checked':''} aria-label="${escapeHtml(name)} 완료"></td><td>${escapeHtml(name)}</td><td>${row.need}</td>`;
        const cb=tr.querySelector('input'); cb.addEventListener('change',()=>{ if(cb.checked) collectionDone.add(row.id); else collectionDone.delete(row.id); save(collectionDoneKey,[...collectionDone]); renderCollection(); });
        tbody.appendChild(tr);
      });
      document.getElementById('emptyCollection').classList.toggle('hidden', rows.length>0);
    }

    // ===================== 컴포넌트 =====================
    function Card(it){
      const root=document.createElement('article'); root.className='card';
      if(state.mode==='trade') root.classList.add('clickable');
      root.innerHTML=`
        <div class="row">
          <h3>${escapeHtml(it.name)}</h3>
          <div class="row" style="gap:6px">
            <span class="tag">${escapeHtml(it.category)} • ${escapeHtml(it.tier||'-')}</span>
            <button class="btn ghost fav" aria-label="즐겨찾기" title="즐겨찾기">${favorites.has(it.id)?'⭐':'☆'}</button>
          </div>
        </div>
        <div class="row muted"><span>기준가</span><strong>${fmt(it.base||0)}</strong></div>`;
      // 모드가 무역섬이면 카드 클릭 시 계산 팝업
      if(state.mode==='trade') root.addEventListener('click',()=> openCalc(it));
      // 즐겨찾기 버튼 토글 (버블링 막기)
      const favBtn=root.querySelector('.fav');
      favBtn.addEventListener('click',(e)=>{ e.stopPropagation(); if(favorites.has(it.id)) favorites.delete(it.id); else favorites.add(it.id); save(favKey,[...favorites]); favBtn.textContent=favorites.has(it.id)?'⭐':'☆'; });
      return root;
    }

    // ===================== 계산 모달 =====================
    const modal=$('#calcModal');
    function openCalc(item){
      modal.classList.add('open');
      $('#calcJob').textContent = item.category || '-';
      $('#calcItem').textContent = item.name;
      $('#calcBase').textContent = fmt(item.base||0);
      $('#calcPct').value='';
      $('#calcQty').value=1;
      $('#calcResult').textContent='';
      modal.dataset.item = JSON.stringify(item);
    }
    function closeCalc(){ modal.classList.remove('open'); }
    $$('#calcModal [data-close]').forEach(el=> el.addEventListener('click', closeCalc));
    modal.addEventListener('click',(e)=>{ if(e.target.classList.contains('backdrop')) closeCalc(); });

    $('#btnCalc').addEventListener('click',()=>{
      const item=JSON.parse(modal.dataset.item||'{}');
      const base=Number(item.base||0);
      const pct=clamp(parseFloat($('#calcPct').value||'0'), -30, 80);
      const qty=Math.max(1, parseInt($('#calcQty').value||'1',10));
      $('#calcPct').value=pct; // 범위 보정 반영
      const unit=Math.round(base*(1+pct/100));
      const total=unit*qty;
      $('#calcResult').textContent=`= 단가 ${fmt(unit)} × ${qty} → ${fmt(total)}`;
      logToMemo(`[${stamp()}] 무역섬 계산 · ${item.category||'-'} · ${item.name} · 기준가 ${fmt(base)} · 변동 ${pct}% · 수량 ${qty} → 합계 ${fmt(total)}`);
    });

    // ===================== 메모 =====================
    function initMemo(){
      const txt=$('#memo'); const saved=load(memoKey,''); txt.value=saved; let t;
      txt.addEventListener('input',()=>{ clearTimeout(t); t=setTimeout(()=>{ save(memoKey, txt.value); stampSaved(); },300); });
      $('#btnMemoClear').addEventListener('click',()=>{
        if(confirm('메모를 모두 지울까요?')){
          txt.value='';
          try{ localStorage.removeItem(memoKey); }catch(e){}
          save(memoKey,'');
          stampSaved();
        }
      });
      $('#btnMemoExport').addEventListener('click',()=>{ const blob=new Blob([txt.value],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='jetty-memo.txt'; a.click(); URL.revokeObjectURL(a.href); });
      $('#memoImport').addEventListener('change', async (e)=>{ const file=e.target.files?.[0]; if(!file) return; const text=await file.text(); txt.value=text; save(memoKey,text); stampSaved(); e.target.value=''; });
    }
    function stampSaved(){ $('#memoSaved').textContent='저장됨 · '+ new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

    // ===================== 이벤트/단축키 =====================
    $('#q').addEventListener('input', e=>{ state.q=e.target.value; renderSearch(); });
    $('#tier').addEventListener('change', e=>{ state.tier=e.target.value; renderSearch(); });

    $('#btnFavoritesOnly').addEventListener('click', ()=>{ state.favoritesOnly=!state.favoritesOnly; $('#btnFavoritesOnly').setAttribute('aria-pressed', String(state.favoritesOnly)); renderSearch(); });

    // 컬렉션 / 무역섬 모드 토글
    $('#btnCollection').addEventListener('click', ()=>{ state.view = (state.view==='collection')? 'search' : 'collection'; if(state.view==='collection') renderCollection(); else renderSearch(); syncUrl(); });
    $('#btnBackToSearch').addEventListener('click', ()=>{ state.view='search'; renderSearch(); syncUrl(); });
    $('#btnTrade').addEventListener('click', ()=>{ state.mode = (state.mode==='trade')? 'search' : 'trade'; renderSearch(); syncUrl(); });

    // 단축키
    window.addEventListener('keydown',(e)=>{
      if(e.key==='/'&&document.activeElement!==$('#q')){ e.preventDefault(); $('#q').focus(); }
      if(e.key.toLowerCase()==='f'){ e.preventDefault(); $('#btnFavoritesOnly').click(); }
      if(e.key.toLowerCase()==='c'){ e.preventDefault(); $('#btnCollection').click(); }
      if(e.key.toLowerCase()==='t'){ e.preventDefault(); $('#btnTrade').click(); }
      if(e.key.toLowerCase()==='m'){
        e.preventDefault();
        const isMobile=window.matchMedia('(max-width:960px)').matches;
        if(isMobile){ $('#memoPane').classList.toggle('open'); if($('#memoPane').classList.contains('open')) $('#memo').focus(); }
        else { $('#memo').focus(); }
      }
    });
    $('#btnMemo').addEventListener('click', ()=>{ $('#memoPane').classList.toggle('open'); if($('#memoPane').classList.contains('open')) $('#memo').focus(); });

    // ===================== URL 동기화 =====================
    function syncUrl(){
      const p=new URLSearchParams();
      if(state.q) p.set('q', state.q);
      if(state.category&&state.category!=='전체') p.set('cat', state.category);
      if(state.tier) p.set('tier', state.tier);
      if(state.favoritesOnly) p.set('fav','1');
      p.set('view', state.view);
      p.set('mode', state.mode);
      if(state.collectionCategory && state.collectionCategory!=='전체') p.set('ccat', state.collectionCategory);
      history.replaceState(null, '', `${location.pathname}?${p.toString()}`);
    }
    function readUrl(){
      const p=new URLSearchParams(location.search);
      state.q=p.get('q')||''; document.getElementById('q').value=state.q;
      state.category=p.get('cat')||'전체';
      state.tier=p.get('tier')||''; document.getElementById('tier').value=state.tier;
      state.favoritesOnly=p.get('fav')==='1'; document.getElementById('btnFavoritesOnly').setAttribute('aria-pressed', String(state.favoritesOnly));
      const v=p.get('view'); state.view=(v==='collection')? v : 'search';
      state.mode = (p.get('mode')==='trade')? 'trade' : 'search';
      state.collectionCategory = p.get('ccat') || '전체';
    }

    // ===================== 부트스트랩 =====================
    function init(){ initChips(); initCollectionChips(); initMemo(); readUrl(); if(state.view==='collection') renderCollection(); else renderSearch(); stampSaved(); }
    init();

    // ===================== 간단 런타임 테스트 =====================
    (function selfTests(){
      try {
        console.assert(typeof renderSearch === 'function', 'renderSearch must exist');
        console.assert(typeof renderCollection === 'function', 'renderCollection must exist');
        console.assert(document.getElementById('list'), '#list must exist');
        console.assert(document.getElementById('collectionBody'), '#collectionBody must exist');
        // 추가 테스트: 컬렉션 칩 생성
        const labels=['전체','블록','자연','광부','전리품','커스텀'];
        const chips=[...document.querySelectorAll('#collectionChips .chip')].map(x=>x.textContent);
        console.assert(labels.every(l=>chips.includes(l)), 'collection chips should include all categories');
        // 필터 테스트: 블록 카테고리 선택 시 '거친 흙'이 존재
        state.collectionCategory='블록'; renderCollection();
        console.assert(document.querySelector('#collectionBody').textContent.includes('거친 흙'), '블록 필터 should show 거친 흙');
        // 검색/무역섬 토글 테스트
        state.mode='trade'; renderSearch();
        const firstCard=document.querySelector('.card.clickable');
        console.assert(!!firstCard, 'in trade mode, cards should be clickable');
        // 즐겨찾기 토글 테스트
        const before=favorites.size; favorites.add('test-id'); save(favKey,[...favorites]);
        console.assert(favorites.size===before+1, 'favorites should add without error');
        // 복구
        favorites.delete('test-id'); save(favKey,[...favorites]);
        // 컬렉션 상태 원복
        state.collectionCategory='전체'; renderCollection();
        state.mode='search'; renderSearch();
      } catch (e) { console.error('Self-tests failed', e); }
    })();
  </script>
</body>
</html>
